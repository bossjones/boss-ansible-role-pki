---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

- name: DebOps pre_tasks hook
  include: "{{ lookup('task_src', 'pki/pre_main.yml') }}"

- name: Generate random session token
  set_fact:
    boss__pki__fact_session_token: '{{ 9999999999999999999999999999999999999 | random | string | hash("sha256") }}'
  delegate_to: 'localhost'
  become: False
  run_once: True

- name: Expose host FQDN and library path in temporary variables
  set_fact:
    boss__pki__fact_fqdn: '{{ boss__pki__fqdn }}'
    boss__pki__fact_lib_path: '{{ (ansible_local.root.lib
                            if (ansible_local|d() and ansible_local.root|d() and
                                ansible_local.root.lib|d())
                            else "/usr/local/lib") + "/pki" }}'

# Install PKI packages [[[
- name: Install PKI packages
  apt:
    name: '{{ item }}'
    state: 'latest'
    install_recommends: False
    cache_valid_time: '{{ ansible_local.core.cache_valid_time
                          if (ansible_local|d() and ansible_local.core|d() and
                              ansible_local.core.cache_valid_time|d())
                          else "86400" }}'
  with_flattened:
    - '{{ boss__pki__base_packages }}'
    - '{{ boss__pki__acme_packages
          if (boss__pki__acme|bool or boss__pki__acme_install|bool)
          else [] }}'
    - '{{ boss__pki__packages }}'
  when: boss__pki__enabled | bool
# .. ]]]

# Assert that required dependencies are met as documented [[[
- name: Check Ansible Controller bash version
  command: "/usr/bin/env bash -c 'echo $BASH_VERSION'"
  changed_when: False
  register: boss__pki___register_bash_version
  delegate_to: 'localhost'
  become: False
  run_once: True
  check_mode: False

- name: Check Ansible Controller crypto library version
  shell: |
    {% if boss__pki__ca_library == 'gnutls' %}
    certtool --version | head -n 1 | awk '{print $NF}'
    {% elif boss__pki__ca_library == 'openssl' %}
    openssl version | awk '{print $2}'
    {% endif %}
  changed_when: False
  register: boss__pki___register_crypto_library_version
  delegate_to: 'localhost'
  become: False
  run_once: True
  check_mode: False

- name: Assert that required dependencies are met as documented
  assert:
    that:
      - 'boss__pki___register_bash_version.stdout | regex_replace("[^0-9.]", "") | version_compare("4.3.0", ">=")'
      - 'boss__pki___register_crypto_library_version.stdout | regex_replace("[a-z]", "") | version_compare("1.0.1" if (boss__pki__ca_library == "openssl") else boss__pki___register_crypto_library_version.stdout, ">=")'
  delegate_to: 'localhost'
  become: False
  run_once: True
  when: boss__pki__authorities|d() and boss__pki__dependent_authorities|d()
# .. ]]]

# Create scripts and library/secrets directory [[[
- name: Create library directory
  file:
    path: '{{ boss__pki__fact_lib_path }}'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0755'
  when: boss__pki__enabled | bool

- name: Install local PKI scripts
  copy:
    src: 'secret/pki/lib/'
    dest: '{{ secret + "/pki/lib/" }}'
    mode: '0755'
  become: False
  delegate_to: 'localhost'
  run_once: True
  when: (boss__pki__authorities or boss__pki__dependent_authorities)

- name: Install remote PKI scripts
  copy:
    src: 'usr/local/lib/pki/'
    dest: '{{ boss__pki__fact_lib_path }}'
    owner: 'root'
    group: 'root'
    mode: '0755'
  when: boss__pki__enabled | bool
# .. ]]]

- name: Create private groups if requested
  group:
    name: '{{ item.name | d(item) }}'
    system: '{{ (item.system | d(True)) | bool }}'
    state: 'present'
  with_items: '{{ boss__pki__private_groups_present }}'
  when: ((boss__pki__enabled|bool and boss__pki__private_groups_present) and
         (item.when|d(True) | bool))

- name: Configure acme-tiny support
  include: acme_tiny.yml
  when: (boss__pki__enabled|bool and
         (boss__pki__acme|bool or boss__pki__acme_install|bool))

# Initialize PKI realms [[[

- name: Ensure that /etc/pki directory exists
  file:
    path: '/etc/pki'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0755'

- name: Ensure that sensitive files are excluded from version control
  template:
    src: 'etc/pki/gitignore.j2'
    dest: '/etc/pki/.gitignore'
    owner: 'root'
    group: 'root'
    mode: '0644'

- name: Initialize PKI realms
  environment:
    boss__PKI__ROOT: '{{ boss__pki__root }}'
    boss__PKI__ACME: '{{ (item.acme | d(boss__pki__acme)) | bool | lower }}'
    boss__PKI__INTERNAL: '{{ (item.internal | d(boss__pki__internal)) | bool | lower }}'
    boss__PKI__LIBRARY: '{{ item.library | d(boss__pki__library) }}'
    boss__PKI__ACME_LIBRARY: '{{ item.acme_library | d(boss__pki__acme_library) }}'
  command: |
           "{{ boss__pki__fact_lib_path }}/pki-realm" init -n "{{ item.name }}"
           --authority-preference "{{ (item.authority_preference | d(boss__pki__authority_preference)) | join('/') }}"
           --library "{{ item.library | d(boss__pki__library) }}"
           --realm-key-size "{{ item.realm_key_size | d(boss__pki__realm_key_size) }}"
           --internal "{{ (item.internal | d(boss__pki__internal)) | bool | lower }}"
           --private-dir-group "{{ item.private_dir_group | d(boss__pki__private_group) }}"
           --private-file-group "{{ item.private_file_group | d(boss__pki__private_group) }}"
           --private-dir-acl-groups "{{ (item.private_dir_acl_groups | d(boss__pki__private_dir_acl_groups)) | join('/') }}"
           --private-file-acl-groups "{{ (item.private_file_acl_groups | d(boss__pki__private_file_acl_groups)) | join('/') }}"
           --acme-ca "{{ item.acme_ca | d(boss__pki__acme_ca) }}"
           --acme-ca-api "{{ item.acme_ca_api | d(boss__pki__acme_ca_api_map[item.acme_ca|d(boss__pki__acme_ca)]) }}"
           --acme-default-subdomains "{{ (item.acme_default_subdomains | d(boss__pki__acme_default_subdomains)) | join('/') }}"
           --acme-challenge-dir "{{ item.acme_challenge_dir | d(boss__pki__acme_challenge_dir) }}"
           --default-domain "{{ item.default_domain | d(boss__pki__default_domain) }}"
           --default-subdomains "{{ (item.default_subdomains | d(boss__pki__default_subdomains)) | join('/') }}"
           --dhparam "{{ (item.dhparam | d(boss__pki__dhparam)) | bool | lower }}"
           --dhparam-file "{{ item.dhparam_file | d(boss__pki__dhparam_file) }}"
           --selfsigned-sign-days "{{ item.selfsigned_sign_days|d('365') }}"
  args:
    creates: '{{ boss__pki__root + "/realms/" + item.name + "/config/realm.conf" }}'
  with_flattened:
    - '{{ boss__pki__realms }}'
    - '{{ boss__pki__group_realms }}'
    - '{{ boss__pki__host_realms }}'
    - '{{ boss__pki__default_realms }}'
    - '{{ boss__pki__dependent_realms }}'
  when: (boss__pki__enabled|bool and item.name is defined and
         (item.enabled|d(True) | bool) and
         (item.when|d(True) | bool))
# ]]]

# Download files [[[
- when: boss__pki__download_extra
  block:
    - name: Download custom private files
      copy:
        src: '{{ item.src | d(omit) }}'
        content: '{{ item.content | d(omit) }}'
        dest: '{{ item.dest }}'
        owner: '{{ item.owner | d("root") }}'
        group: '{{ item.group | d(boss__pki__private_group) }}'
        mode: '{{ item.mode | d("0640") }}'
        directory_mode: '{{ item.directory_mode | d(omit) }}'
        follow: '{{ item.follow | d(omit) }}'
        force: '{{ item.force | d(omit) }}'
      with_flattened:
        - '{{ boss__pki__private_files }}'
        - '{{ boss__pki__group_private_files }}'
        - '{{ boss__pki__host_private_files }}'
      when: (boss__pki__enabled|bool and (item.src is defined or item.content is defined) and
             item.dest is defined)

    - name: Download private realm contents by host
      copy:
        src: '{{ secret + "/pki/realms/by-host/" + boss__pki__fqdn + "/" + item.name + "/private/" }}'
        dest: '/etc/pki/realms/{{ item.name }}/private/'
        owner: 'root'
        group: '{{ item.private_file_group | d(boss__pki__private_group) }}'
        mode: '0640'
      with_items:
        - '{{ boss__pki__realms + boss__pki__group_realms + boss__pki__host_realms + boss__pki__default_realms + boss__pki__dependent_realms }}'
      when: (boss__pki__enabled|bool and item.name is defined and
             (item.enabled|d(True) | bool) and
             (item.when|d(True) | bool))

    - name: Download private realm contents by group
      copy:
        src: '{{ secret + "/pki/realms/by-group/" + item.1 + "/" + item.0.name + "/private/" }}'
        dest: '/etc/pki/realms/{{ item.0.name }}/private/'
        owner: 'root'
        group: '{{ item.private_file_group | d(boss__pki__private_group) }}'
        mode: '0640'
        force: False
      with_nested:
        - '{{ boss__pki__group_realms + boss__pki__default_realms }}'
        - '{{ boss__pki__inventory_groups }}'
      when: (boss__pki__enabled|bool and (item.0.name is defined and
             (item.0.enabled|d(True) | bool) and
             (item.0.when|d(True) | bool)) and
             (item.1 is defined and item.1 in group_names))

    - name: Download private realm contents for all hosts
      copy:
        src: '{{ secret + "/pki/realms/by-group/all/" + item.name + "/private/" }}'
        dest: '/etc/pki/realms/{{ item.name }}/private/'
        owner: 'root'
        group: '{{ item.private_file_group | d(boss__pki__private_group) }}'
        mode: '0640'
        force: False
      with_items:
        - '{{ boss__pki__realms + boss__pki__default_realms }}'
      when: (boss__pki__enabled|bool and item.name is defined and
             (item.enabled|d(True) | bool) and
             (item.when|d(True) | bool))
    # ]]]

# Create new PKI realms [[[
- name: Create new PKI realms
  environment:
    boss__PKI__SESSION_TOKEN: '{{ boss__pki__fact_session_token }}'
  command: |
           "{{ boss__pki__fact_lib_path }}/pki-realm" new-realm -n "{{ item.name }}"
           --subject "{{ item.subject|d([]) | join('/') }}"
           --domains "{{ item.domains|d([]) | join('/') }}"
           --subdomains "{{ item.subdomains|d([]) | join('/') }}"
           --acme "{{ item.acme|d(boss__pki__acme) | bool | lower }}"
           --acme-subject "{{ item.acme_subject|d([]) | join('/') }}"
           --acme-domains "{{ item.acme_domains|d([]) | join('/') }}"
           --acme-subdomains "{{ item.acme_subdomains|d([]) | join('/') }}"
           --subject-alt-names "{{ item.subject_alt_names | d([]) | join('|') }}"
           --acme-alt-names "{{ item.acme_alt_names | d([]) | join('|') }}"
  args:
    creates: '/etc/pki/realms/{{ item.name }}/default.key'
  with_flattened:
    - '{{ boss__pki__realms }}'
    - '{{ boss__pki__group_realms }}'
    - '{{ boss__pki__host_realms }}'
    - '{{ boss__pki__default_realms }}'
    - '{{ boss__pki__dependent_realms }}'
  when: (boss__pki__enabled|bool and item.name is defined and
         (item.enabled|d(True) | bool) and
         (item.when|d(True) | bool))
# ]]]

# Execute PKI realm commands [[[
- name: Execute PKI realm commands
  environment:
    boss__PKI__SESSION_TOKEN: '{{ boss__pki__fact_session_token }}'
  command: '"{{ boss__pki__fact_lib_path }}/pki-realm" run -n "{{ item.name }}"'
  with_flattened:
    - '{{ boss__pki__realms }}'
    - '{{ boss__pki__group_realms }}'
    - '{{ boss__pki__host_realms }}'
    - '{{ boss__pki__default_realms }}'
    - '{{ boss__pki__dependent_realms }}'
  changed_when: False
  when: (boss__pki__enabled|bool and item.name is defined and
         (item.enabled|d(True) | bool) and
         (item.when|d(True) | bool))
# ]]]

# Upload internal certificate requests [[[
- name: Upload internal certificate requests
  fetch:
    src: '/etc/pki/realms/{{ item.name }}/internal/request.pem'
    dest: '{{ secret + "/pki/requests/" + (item.authority | d(boss__pki__default_authority)) +
              "/" + boss__pki__fqdn + "/" + item.name + "/request.pem" }}'
    flat: True
  with_flattened:
    - '{{ boss__pki__realms }}'
    - '{{ boss__pki__group_realms }}'
    - '{{ boss__pki__host_realms }}'
    - '{{ boss__pki__default_realms }}'
    - '{{ boss__pki__dependent_realms }}'
  when: (boss__pki__enabled|bool and item.name is defined and
         ((item.internal|d(True) | bool) and boss__pki__internal|bool) and
         (item.enabled|d(True) | bool) and
         (item.when|d(True) | bool))
# ]]]

# PKI authorities [[[
- name: Initialize PKI authorities
  environment:
    boss__PKI__ROOT: '{{ secret + "/pki" }}'
    boss__PKI__LIBRARY: '{{ item.boss__pki__ca_library | d(boss__pki__ca_library) }}'
    boss__PKI__CA_CERTIFICATES: '{{ secret + "/pki/ca-certificates/" + (item.ca_certificates_path | d(boss__pki__ca_certificates_path)) }}'
  command: ./lib/pki-authority init --name "{{ item.name }}"
           --default-sign-base "{{ boss__pki__default_sign_base }}"
           --root-sign-multiplier "{{ boss__pki__default_root_sign_multiplier }}"
           --ca-sign-multiplier "{{ boss__pki__default_ca_sign_multiplier }}"
           --cert-sign-multiplier "{{ boss__pki__default_cert_sign_multiplier }}"
  args:
    chdir: '{{ secret + "/pki" }}'
    creates: '{{ secret + "/pki/authorities/" + item.name + "/config/authority.conf" }}'
  delegate_to: 'localhost'
  become: False
  run_once: True
  with_flattened:
    - '{{ boss__pki__authorities + boss__pki__dependent_authorities }}'
  when: (item.name is defined and (item.enabled|d(True) | bool))

- name: Create PKI authorities
  environment:
    boss__PKI__SESSION_TOKEN: '{{ boss__pki__fact_session_token }}'
    boss__PKI__ROOT: '{{ secret + "/pki" }}'
    boss__PKI__LIBRARY: '{{ item.boss__pki__ca_library | d(boss__pki__ca_library) }}'
    boss__PKI__CA_CERTIFICATES: '{{ secret + "/pki/ca-certificates/" + (item.ca_certificates_path | d(boss__pki__ca_certificates_path)) }}'
  command: ./lib/pki-authority new-ca --name "{{ item.name }}"
           --type "{{ item.type | d('') }}"
           --domain "{{ item.domain | d(boss__pki__ca_domain) }}"
           --subdomain "{{ item.subdomain }}"
           --subject "{{ item.subject | join('/') }}"
           --issuer-name "{{ item.issuer_name | d('') }}"
           --root-sign-days "{{ item.root_sign_days | d('') }}"
           --ca-sign-days "{{ item.ca_sign_days | d('') }}"
           --cert-sign-days "{{ item.cert_sign_days | d('') }}"
           --system-ca "{{ (item.system_ca | d(True)) | bool | lower }}"
           --alt-authority "{{ item.alt_authority | d('') }}"
           --key-size "{{ item.key_size | d('') }}"
           --crl "{{ item.crl | d(True) }}"
           --ocsp "{{ item.ocsp | d(True) }}"
           --name-constraints "{{ item.name_constraints | d(True) }}"
  args:
    chdir: '{{ secret + "/pki" }}'
    creates: '{{ secret + "/pki/authorities/" + item.name + "/subject/cert.pem" }}'
  delegate_to: 'localhost'
  become: False
  run_once: True
  with_flattened:
    - '{{ boss__pki__authorities + boss__pki__dependent_authorities }}'
  when: (item.name is defined and (item.enabled|d(True) | bool))
# ]]]

# Sign certificate requests [[[
- name: Sign certificate requests for current hosts
  environment:
    boss__PKI__SESSION_TOKEN: '{{ boss__pki__fact_session_token }}'
  command: ./lib/pki-authority sign-by-host
           {% for host in play_hosts %}{{ hostvars[host].boss__pki__fact_fqdn | d('') }} {% endfor %}
  args:
    chdir: '{{ secret + "/pki" }}'
  delegate_to: 'localhost'
  register: boss__pki__register_sign_by_host
  become: False
  run_once: True
  when: (boss__pki__authorities or boss__pki__dependent_authorities)
  changed_when: boss__pki__register_sign_by_host.stdout != ""
# ]]]

# Download files [[[
- when: boss__pki__download_extra
  block:
    - name: Download public realm contents by host
      copy:
        src: '{{ secret + "/pki/realms/by-host/" + boss__pki__fqdn + "/" + item.0.name + "/" + item.1 + "/" }}'
        dest: '/etc/pki/realms/{{ item.0.name }}/{{ item.1 }}/'
        owner: 'root'
        group: 'root'
      with_nested:
        - '{{ boss__pki__realms + boss__pki__group_realms + boss__pki__host_realms + boss__pki__default_realms + boss__pki__dependent_realms }}'
        - [ 'external', 'internal' ]
      when: (boss__pki__enabled|bool and item.0.name is defined and
             (item.0.enabled|d(True) | bool) and
             (item.0.when|d(True) | bool))

    - name: Download custom public files
      copy:
        src: '{{ item.src | d(omit) }}'
        content: '{{ item.content | d(omit) }}'
        dest: '{{ item.dest }}'
        owner: '{{ item.owner | d("root") }}'
        group: '{{ item.group | d(boss__pki__public_group) }}'
        mode: '{{ item.mode | d("0644") }}'
        directory_mode: '{{ item.directory_mode | d(omit) }}'
        follow: '{{ item.follow | d(omit) }}'
        force: '{{ item.force | d(omit) }}'
      with_flattened:
        - '{{ boss__pki__public_files }}'
        - '{{ boss__pki__group_public_files }}'
        - '{{ boss__pki__host_public_files }}'
      when: (boss__pki__enabled|bool and (item.src is defined or item.content is defined) and
             item.dest is defined)

    - name: Download external realm contents by group
      copy:
        src: '{{ secret + "/pki/realms/by-group/" + item.1 + "/" + item.0.name + "/external/" }}'
        dest: '/etc/pki/realms/{{ item.0.name }}/external/'
        owner: 'root'
        group: 'root'
        force: False
      with_nested:
        - '{{ boss__pki__group_realms + boss__pki__default_realms }}'
        - '{{ boss__pki__inventory_groups }}'
      when: (boss__pki__enabled|bool and (item.0.name is defined and
              (item.0.enabled|d(True) | bool) and
              (item.0.when|d(True) | bool)) and
              (item.1 is defined and item.1 in group_names))

    - name: Download external realm contents for all hosts
      copy:
        src: '{{ secret + "/pki/realms/by-group/all/" + item.name + "/external/" }}'
        dest: '/etc/pki/realms/{{ item.name }}/external/'
        owner: 'root'
        group: 'root'
        force: False
      with_items:
        - '{{ boss__pki__realms + boss__pki__default_realms }}'
      when: (boss__pki__enabled|bool and item.name is defined and
             (item.enabled|d(True) | bool) and
             (item.when|d(True) | bool))

    - name: Download custom CA certificates by host
      copy:
        src: '{{ secret + "/pki/ca-certificates/by-host/" + boss__pki__fqdn + "/" }}'
        dest: '/usr/local/share/ca-certificates/pki/'
        owner: 'root'
        group: 'root'
        mode: '0644'
      notify: [ 'Regenerate ca-certificates.crt' ]
      when: boss__pki__system_ca_certificates_download_by_host|d(boss__pki__enabled) | bool

    - name: Download custom CA certificates by group
      copy:
        src: '{{ secret + "/pki/ca-certificates/by-group/" + item + "/" }}'
        dest: '/usr/local/share/ca-certificates/pki/'
        owner: 'root'
        group: 'root'
        force: False
      with_items: '{{ boss__pki__inventory_groups }}'
      notify: [ 'Regenerate ca-certificates.crt' ]
      when: ((boss__pki__system_ca_certificates_download_by_group|d(boss__pki__enabled) | bool) and item in group_names)

    - name: Download custom CA certificates for all hosts
      copy:
        src: '{{ secret + "/pki/ca-certificates/by-group/all/" }}'
        dest: '/usr/local/share/ca-certificates/pki/'
        owner: 'root'
        group: 'root'
        force: '{{ boss__pki__system_ca_certificates_download_all_hosts_force|bool }}'
      notify: [ 'Regenerate ca-certificates.crt' ]
      when: boss__pki__system_ca_certificates_download_all_hosts|d(boss__pki__enabled) | bool
# ]]]

# Execute PKI realm commands [[[
- name: Execute PKI realm commands
  environment:
    boss__PKI__SESSION_TOKEN: '{{ boss__pki__fact_session_token }}'
  command: '"{{ boss__pki__fact_lib_path }}/pki-realm" run -n "{{ item.name }}"'
  with_flattened:
    - '{{ boss__pki__realms }}'
    - '{{ boss__pki__group_realms }}'
    - '{{ boss__pki__host_realms }}'
    - '{{ boss__pki__default_realms }}'
    - '{{ boss__pki__dependent_realms }}'
  changed_when: False
  when: (boss__pki__enabled|bool and item.name is defined and
         (item.enabled|d(True) | bool) and
         (item.when|d(True) | bool))
# ]]]

# Manage PKI scheduler [[[
- name: Manage PKI scheduler
  cron:
    name: 'Process PKI system realms'
    user: 'root'
    cron_file: 'pki-realm-scheduler'
    job: 'test -x "{{ boss__pki__fact_lib_path }}/pki-realm" && "{{ boss__pki__fact_lib_path }}/pki-realm" schedule'
    special_time: '{{ boss__pki__scheduler_interval }}'
    state: '{{ "present" if (boss__pki__enabled|bool and boss__pki__scheduler | bool) else "absent" }}'
# ]]]

- name: Manage system CA certificates
  include: ca_certificates.yml
  when: boss__pki__enabled | bool

# Ansible local facts [[[
- name: Make sure that Ansible local facts directory exists
  file:
    path: '/etc/ansible/facts.d'
    state: 'directory'
    owner: 'root'
    group: 'root'
    mode: '0755'

- name: Save local facts
  template:
    src: 'etc/ansible/facts.d/pki.fact.j2'
    dest: '/etc/ansible/facts.d/pki.fact'
    owner: 'root'
    group: 'root'
    mode: '0755'
  register: boss__pki__register_facts
  notify: [ 'Gather PKI facts' ]

- name: Flush handlers for PKI if needed
  meta: flush_handlers
  when: boss__pki__register_facts|changed

- name: DebOps post_tasks hook
  include: "{{ lookup('task_src', 'pki/post_main.yml') }}"

# ]]]
